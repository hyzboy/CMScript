set(DEVIL_VM_PUBLIC_HEADERS
	${CMSCRIPT_ROOT_INCLUDE_PATH}/hgl/devil/DevilVM.h
)

set(DEVIL_VM_TOKEN_FILES
	${CMAKE_CURRENT_SOURCE_DIR}/as_tokendef.h
	${CMAKE_CURRENT_SOURCE_DIR}/as_tokenizer.h
	${CMAKE_CURRENT_SOURCE_DIR}/as_tokenizer.cpp
)

set(DEVIL_VM_COMMAND_FILES
	${CMAKE_CURRENT_SOURCE_DIR}/DevilCommand.h
	${CMAKE_CURRENT_SOURCE_DIR}/DevilCommand.cpp
)

set(DEVIL_VM_MODULE_FILES
	${CMAKE_CURRENT_SOURCE_DIR}/DevilModule.h
	${CMAKE_CURRENT_SOURCE_DIR}/DevilModule.cpp
)

set(DEVIL_VM_CONTEXT_FILES
	${CMAKE_CURRENT_SOURCE_DIR}/DevilContext.h
	${CMAKE_CURRENT_SOURCE_DIR}/DevilContext.cpp
)

set(DEVIL_VM_ENUM_FILES
	${CMAKE_CURRENT_SOURCE_DIR}/DevilEnum.h
	${CMAKE_CURRENT_SOURCE_DIR}/DevilEnum.cpp
)

set(DEVIL_VM_FUNC_FILES
	${CMAKE_CURRENT_SOURCE_DIR}/DevilFunc.h
	${CMAKE_CURRENT_SOURCE_DIR}/DevilFunc.cpp
)

set(DEVIL_VM_PARSE_FILES
	${CMAKE_CURRENT_SOURCE_DIR}/DevilParse.h
	${CMAKE_CURRENT_SOURCE_DIR}/DevilParse.cpp
)

set(DEVIL_VM_VARIABLE_FILES
	${CMAKE_CURRENT_SOURCE_DIR}/DevilVariable.h
	${CMAKE_CURRENT_SOURCE_DIR}/DevilVariable.cpp
)

set(DEVIL_VM_CORE_FILES
	${CMAKE_CURRENT_SOURCE_DIR}/DevilVM.cpp
)

if(MSVC AND CMAKE_SIZEOF_VOID_P EQUAL 8)
	enable_language(ASM_MASM)

	set(DEVIL_VM_CALLX64_SRC
		${CMAKE_CURRENT_SOURCE_DIR}/MicrosoftCallX64.asm
	)

	set(DEVIL_VM_CALLX64_CMD
		${CMAKE_CURRENT_SOURCE_DIR}/callx64.cmd
	)

	set(DEVIL_VM_CALLX64_OBJ
		${CMAKE_CURRENT_BINARY_DIR}/MicrosoftCallX64.obj
	)

	file(TO_NATIVE_PATH "${DEVIL_VM_CALLX64_OBJ}" DEVIL_VM_CALLX64_OBJ_NATIVE)

	add_custom_command(
		OUTPUT ${DEVIL_VM_CALLX64_OBJ}
		COMMAND cmd /c "${DEVIL_VM_CALLX64_CMD}"
		COMMAND ${CMAKE_COMMAND} -E copy_if_different
			"${CMAKE_CURRENT_SOURCE_DIR}/MicrosoftCallX64.obj"
			"${DEVIL_VM_CALLX64_OBJ_NATIVE}"
		DEPENDS ${DEVIL_VM_CALLX64_SRC} ${DEVIL_VM_CALLX64_CMD}
		WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}
		VERBATIM
	)

	set_source_files_properties(
		${DEVIL_VM_CALLX64_OBJ}
		PROPERTIES
			GENERATED TRUE
	)

	add_custom_target(DevilVMCallX64 DEPENDS ${DEVIL_VM_CALLX64_OBJ})

	list(APPEND DEVIL_VM_CORE_FILES
		${DEVIL_VM_CALLX64_OBJ}
	)

	set(DEVIL_VM_CALLX64_TARGET DevilVMCallX64 PARENT_SCOPE)
endif()

set(DEVILSCRIPT_SOURCE
	${DEVIL_VM_PUBLIC_HEADERS}
	${DEVIL_VM_TOKEN_FILES}
	${DEVIL_VM_COMMAND_FILES}
	${DEVIL_VM_MODULE_FILES}
	${DEVIL_VM_CONTEXT_FILES}
	${DEVIL_VM_ENUM_FILES}
	${DEVIL_VM_FUNC_FILES}
	${DEVIL_VM_PARSE_FILES}
	${DEVIL_VM_VARIABLE_FILES}
	${DEVIL_VM_CORE_FILES}
)

source_group("DevilVM\\Public" FILES ${DEVIL_VM_PUBLIC_HEADERS})
source_group("DevilVM\\Token" FILES ${DEVIL_VM_TOKEN_FILES})
source_group("DevilVM\\Command" FILES ${DEVIL_VM_COMMAND_FILES})
source_group("DevilVM\\Module" FILES ${DEVIL_VM_MODULE_FILES})
source_group("DevilVM\\Context" FILES ${DEVIL_VM_CONTEXT_FILES})
source_group("DevilVM\\Enum" FILES ${DEVIL_VM_ENUM_FILES})
source_group("DevilVM\\Func" FILES ${DEVIL_VM_FUNC_FILES})
source_group("DevilVM\\Parse" FILES ${DEVIL_VM_PARSE_FILES})
source_group("DevilVM\\Variable" FILES ${DEVIL_VM_VARIABLE_FILES})
source_group("DevilVM\\Core" FILES ${DEVIL_VM_CORE_FILES})

set(DEVIL_SCRIPT_SOURCES ${DEVILSCRIPT_SOURCE})
set(DEVIL_SCRIPT_INCLUDE_DIRS ${CMSCRIPT_ROOT_INCLUDE_PATH})

set(DEVIL_SCRIPT_SOURCES ${DEVIL_SCRIPT_SOURCES} PARENT_SCOPE)
set(DEVIL_SCRIPT_INCLUDE_DIRS ${DEVIL_SCRIPT_INCLUDE_DIRS} PARENT_SCOPE)
